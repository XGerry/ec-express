doctype html
include mixins
html
	include includes/head
		title=item.sku
	body
		#wrapper
			+sidebarNav("orders")
			#page-content
				nav.navbar.navbar-light.bg-light.navbar-expand-sm.sticky-top
					button.btn.btn-secondary.btn-toggles(type="button").m-0.position-relative#left-menu-toggle
						i.far.fa-bars.fa-fw
					span.navbar-brand.mb-0.h1.pl-2=order.orderId
					//form.form-inline
						select.form-control#orderStatus
							option(value=1) New
							option(value=2) Processing
							option(value=3) Backorder
							option(value=6) Pre-order
							option(value=9) Awaiting Payment
							option(value=13) Awaiting Shipment
							option(value=4) Shipped
					span.navbar-text#orderInfo.ml-2
					ul.navbar-nav.ml-auto
						li.dropdown.nav-item
							a.nav-link.dropdown-toggle(href="#" aria-haspopup="true" data-toggle="dropdown") Actions
							ul.dropdown-menu.dropdown-menu-right
								a(href="https://www.ecstasycrafts." + (order.canadian ? "ca" : "com") + "/admin/order_details.asp?orderid="+order.cartOrder.OrderID target="_blank").dropdown-item View on 3D Cart
								a(href="/shipping-label?id="+order._id target="_blank").dropdown-item White Label
								.dropdown-divider
								a(href="#").dropdown-item#removeFromBatchButton Remove from Batch
								a#deleteOrder(href="#").dropdown-item.bg-danger.text-white Delete
						button.btn-primary.btn.mr-2(type="button")#addItemButton Add Item
						.btn-group
							button.btn.btn-success(type="button")#saveOrderButton Save
							button.btn.btn-success.dropdown-toggle.dropdown-toggle-split(type="button" data-toggle="dropdown")
							.dropdown-menu.dropdown-menu-right
								a.dropdown-item(href="#")#updateQuickbooks Update in QB
								a.dropdown-item(href="#")#invoiceOrder Invoice Order

				.container.pt-3
					.row
						.col
							button.btn.btn-primary(type="button") Refresh From 3D Cart
		+footer
		script.
			var socket = io();
			var theOrder = !{JSON.stringify(order)};
			var theItem;
			var addingItem = false;
			console.log(theOrder);

			$(document).ready(e => {
				$('#addItemButton').click(e => {
					addingItem = true;
					var newItem = {
						item: {
							sku: ''
						},
						quantity: 1,
						price: 0,
						pickedQuantity: 0
					}
					showModal(newItem);
				});

				$('#saveItemButton').click(e => {
					theItem.quantity = $('#itemQuantity').val();
					theItem.price = $('#itemPrice').val();
					theItem.pickedQuantity = $('#itemPickedQuantity').val();
					if (addingItem) {
						theOrder.items.push(theItem);
					}
					recalculateTotal();
					socket.emit('updateOrder', theOrder, response => {
						location.reload();
					});
				});

				$('#deleteItemButton').click(e => {
					theOrder.items.splice(theOrder.items.indexOf(theItem), 1);
					socket.emit('updateOrder', theOrder, response => {
						location.reload();
					});
				});

				$('#itemSKU').change(e => {
					socket.emit('searchSKU', $('#itemSKU').val(), items => {
						if (items.length == 0) { // item was not found
							alert('The SKU was not found in the database. Please try again.')
							$('#itemSKU').select();
							return;
						}
						theItem.item = items[0];
						theItem.price = determineItemPrice(items[0]);
						$('#itemPrice').val(theItem.price.toFixed(2));
					});
				});

				$('#addItemModal').on('shown.bs.modal', e => {
					$('#itemSKU').select();
				});

				$('#addItemModal').on('hidden.bs.modal', e => {
					addingItem = false;
				});

				$('#pickedCheckbox').on('change', e => {
					theOrder.picked = $('#pickedCheckbox').is(':checked');
				});

				$('#invoicedCheckbox').on('change', e => {
					theOrder.invoiced = $('#invoicedCheckbox').is(':checked');
				});

				$('#paidCheckbox').on('change', e => {
					theOrder.paid = $('#paidCheckbox').is(':checked');
				});

				$('#rushCheckbox').on('change', e => {
					theOrder.rush = $('#rushCheckbox').is(':checked');
				});

				$('#holdCheckbox').on('change', e => {
					theOrder.hold = $('#holdCheckbox').is(':checked');
				});

				$('#saveOrderButton').click(e => {
					theOrder.shippingCost = $('#orderShippingCost').val();
					recalculateTotal();
					socket.emit('updateOrder', theOrder, response => {
						console.log(response);
						$('#orderInfo').text('Saved Successfully!');
						setTimeout(() => {
							$('#orderInfo').text('');
						}, 2000);
					});
				});

				$('#updateQuickbooks').click(e => {
					theOrder.shippingCost = $('#orderShippingCost').val();
					socket.emit('updateOrderQB', theOrder._id, message => {
						$('#orderInfo').text(message);
						setTimeout(() => {
							$('#orderInfo').text('');
						}, 2000);
					});
				});

				$('#invoiceOrder').click(e => {
					theOrder.shippingCost = $('#orderShippingCost').val();
					socket.emit('invoiceOrder', theOrder._id, message => {
						$('#orderInfo').text(message[0].message + ' - Run the web connector.');
						setTimeout(() => {
							$('#orderInfo').text('');
						}, 2000);
					});
				});

				$('#removeFromBatchButton').click(e => {
					e.preventDefault();
					var yes = confirm('Are you sure you want to remove this order from it\'s batch?');
					if (yes) {
						socket.emit('removeOrderFromBatch', theOrder._id, response => {
							location.reload();
						});
					}
				});

				$('#deleteOrder').click(e => {
					e.preventDefault();
					var yes = confirm('Are you sure you want to delete the order from the system? If the order has a status of "New" in 3D Cart it will be imported again.');
					if (yes) {
						socket.emit('deleteOrder', theOrder._id, cb => {
							window.location = '/orders';
						});
					}
				});
			});

			function determineItemPrice(item) {
				if (theOrder.canadian) {
					if (theOrder.customerType == 0) {
						return item.canPrice;
					} else {
						return item.canWholesalePrice;
					}
				} else {
					if (theOrder.customerType == 0) {
						return item.usPrice;
					} else {
						return item.usWholesalePrice;
					}
				}
			}

			function showModal(item) {
				theItem = item;
				$('#addItemModal').modal();
				$('#itemSKU').val(item.item.sku);
				$('#itemQuantity').val(item.quantity);
				if (item.price)
					$('#itemPrice').val(item.price.toFixed(2));
				$('#itemPickedQuantity').val(item.pickedQuantity);
			}

			function editItem(id) {
				for (item of theOrder.items) {
					if (item._id == id)
						showModal(item);
				}
			}

			function recalculateTotal() {
				theOrder.orderValue = 0;
				theOrder.items.forEach(item => {
					theOrder.orderValue += (item.quantity * item.price);
				});
			}


extends templates/default

append nav-items-right
  button.btn.btn-outline-success.mr-2#downloadReport Download
  button.btn.btn-primary#runReport Run

append head
  title Item Sales Report
  script(src="/js/views/salesReportTable.js")

append body
  .container-fluid
    .row
      .col
        label From
        input.form-control(type="date")#fromDate
      .col
        label To
        input.form-control(type="date")#toDate
      .col
        label Manufacturer
        select.form-control#manufacturer
          option(value="all") All
          for manufacturer in manufacturers
            option(value=manufacturer.name)= manufacturer.name
    hr
    .row
      .col
        table.table.table-striped#reportTable
          thead
            th SKU
            th Name
            th Manufacturer
            th Quantity Ordered
            th Quantity Fulfilled
            th Number of Orders
          tbody#reportTableBody

  script.
    let socket = io();
    let theItems = {};
    let datatable = $('#reportTable').DataTable({
      data: [],
      columns: [{
        data: '_id.sku'
      }, {
        data: '_id.name'
      }, {
        data: '_id.manufacturerName',
        defaultContent: 'None'
      }, {
        data: 'totalOrdered'
      }, {
        data: 'totalPicked'
      }, {
        data: 'orders'
      }],
      pageLength: 100,
      order: [[3, 'desc']]
    });

    $('#runReport').click(e => {
      axios.get('/api/reports/items/sales/', { 
      params: {
        from: $('#fromDate').val(),
        to: $('#toDate').val(),
        manufacturer: $('#manufacturer').val()
      }}).then(response => {
        console.log(response.data);
        theItems = response.data;
        datatable.clear();
        datatable.rows.add(response.data);
        datatable.draw();
      });
    });

    $('#downloadReport').click(e => {
      let file = 'sku,name,manufacturer,ordered,picked,orders\r\n';
      theItems.forEach(item => {
        file += item._id.sku + ',';
        file += item._id.name + ',';
        file += item._id.manufacturerName + ',';
        file += item.totalOrdered + ',';
        file += item.totalPicked + ',';
        file += item.orders.length + ',';
        file += '\r\n';
      });

      var blob = new Blob([file], { type: 'text/csv;charset=utf-8;' });
      var a = document.createElement("a");
      document.body.appendChild(a);
      a.style = "display: none";
      var url = window.URL.createObjectURL(blob);
      a.href = url;
      a.download = "item-report-" + moment($('#fromDate').val()).utc().format('YYYY-MM-DD') + "-" + moment($('#toDate').val()).utc().format('YYYY-MM-DD') + ".csv";
      a.click();
      window.URL.revokeObjectURL(url);
    });